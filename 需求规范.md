# 📝 间歇节奏训练应用 (Rhythm-Interval Trainer) 需求规范

## 1. 项目概述

创建一个基于 HTML5 的 移动端 Web 应用，旨在帮助用户通过自定义的节奏和间歇时间进行周期性训练。该应用核心在于**高精度的音频节拍**和**灵活的任务嵌套**。

---

## 2. 核心功能模块

### A. 训练管理 (Data Management)

* **多计划存储**：支持创建、重命名、删除多个训练计划。
* **持久化**：数据默认存储在浏览器的 `LocalStorage` 中，确保关闭页面后数据不丢失。

### B. 任务层级结构 (Hierarchy)

应用应遵循以下逻辑嵌套：

1. **训练计划 (Plan)**：顶层容器。
2. **训练组 (Group)**：
* 可设置 **循环次数 (Loops)**。
* 包含一个或多个训练项。


3. **训练项 (Item)**：
* **时长 (Duration)**：该动作持续的总秒数。
* **节奏 (BPM)**：每分钟节拍数。
* **间歇 (Interval)**：在该项结束后的休息时间。

### C. 训练执行 (Execution)

* **实时节拍器**：在训练项进行时，按照设定的 BPM 发出清脆的点击声（Click Sound）。
* **状态倒计时**：清晰显示当前项的剩余时间、当前循环轮次以及下一项预告。
* **后台播放方案**：利用 Web Audio API 结合特定技术确保锁屏或切后台时不被系统挂起。

### D. 语音播报系统 (TTS)

* **播报时机**：在每个训练项开始前的 3 秒（或间歇时间内），系统自动播报：“下一项：[动作名称]”。
* **播报内容**：支持播报项目名称、倒计时结束提醒。
* **技术路线**：使用浏览器原生的 `Web Speech API` (window.speechSynthesis)。

### E. 默认配置 (Preset Library)

* **内置模板**：应用初始化时，自动加载 2-3 个经典配置（如：Tabata 经典训练、基础节奏慢跑等）。
* **重置功能**：用户可以一键恢复到默认预设。

---

## 3. 数据结构设计 (JSON 示例)

为了程序好写，建议你的数据底层逻辑设计如下：

```json
{
  "planName": "晨间体能训练",
  "groups": [
    {
      "loop": 3,
      "items": [
        { "name": "深蹲", "duration": 30, "bpm": 60, "rest": 10 },
        { "name": "开合跳", "duration": 30, "bpm": 120, "rest": 15 }
      ]
    }
  ]
}

```

---

## 4. 界面布局建议 (UI/UX)

| 模块 | 说明 |
| --- | --- |
| **侧边栏/列表** | 显示已保存的计划，点击切换。 |
| **编辑区** | 采用卡片式布局，动态添加/删除组和项。 |
| **播放控制台** | 醒目的“开始/暂停/重置”按钮，以及总进度条。 |
| **视觉反馈** | 节拍响动时，屏幕同步闪烁或进度条跳动。 |

---

## 5. 关键技术实现要点

### 1. 音频精度 (Timing)

> **注意**：不要使用 `setInterval` 来处理节拍，因为它在浏览器后台会大幅降低精度。

* **方案**：使用 **Web Audio API** 的 `currentTime` 进行调度，这能提供硬件级的定时精度。

### 2. 后台持续运行 (Background Playback)

由于浏览器对后台 JS 限制非常严格，你的需求中“后台播放”可以通过以下“组合拳”实现：

1. **静音音频占位**：播放一段 10 小时的循环静音 MP3，这会让移动端浏览器认为这是一个“媒体播放器”，从而不挂起进程。
2. **保持屏幕常亮**：调用 `navigator.wakeLock.request('screen')`。

### 3. 提示音选择

* 提供 2-3 种内置音效（如：木鱼声、电子嘀声、清脆敲击声）。

### 4. 语音合成逻辑 (Web Speech API)

由于训练时背景有节拍声，语音播报需要协调：

* **逻辑**：当进入间歇倒计时最后 3 秒时，触发播报函数。
* **代码参考**：
```javascript
function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'zh-CN';
  window.speechSynthesis.speak(msg);
}

```

### 5. 状态机逻辑

程序需要维护一个严密的“状态机”：

1. **准备中** (Count Down)
2. **训练中** (Action + Metronome)
3. **播报中** (TTS + Next Item Prep)
4. **间歇中** (Rest)
5. **循环判定** (Loop Check)

---